name: Run API Tests

on:
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  newman:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Newman
        run: |
          npm install -g newman
          npm install -g newman-reporter-html

      - name: Create reports folder
        run: mkdir -p reports

      - name: Start mock server
        run: |
          npx yaml-server --hotReload=off --autoStart=off --port 3000 --database ./mockApi/db_stage.yaml &
          echo "Waiting for server to start..."
          sleep 5

      - name: Run Postman collection
        run: |
          newman run store.collectionmy.json -e env.json -r cli,html --reporter-html-export reports/report.html --suppress-exit-code

      - name: Commit Newman report if exists
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"
          if [ -f reports/report.html ]; then
            cp reports/report.html index.html
            git add reports/report.html index.html
            git commit -m "Update Newman HTML report" || echo "No changes to commit"
            git push https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git
          else
            echo "No report to commit"
          fi
